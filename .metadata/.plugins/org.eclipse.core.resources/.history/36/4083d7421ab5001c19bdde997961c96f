/*
 * API_uart.c
 *
 *  Created on: Apr 4, 2022
 *      Author: Lucas
 */

#include "API_uart.h"

static const char * BAUDRATE = "Baudrate: 9600\r\n";
static const char * WORD_LENGTH = "Word length: 8 bits\r\n";
static const char * STOP_BITS = "Stop bits: 1 bit\r\n";
static const char * PARITY = "Parity: Odd\r\n";
static const char * HW_CTRL = "Hardware control: None\r\n";
static const char * MODE = "Mode: TX/RX\r\n";
static const char * OVERSAMPLING = "Oversampling: 16\r\n";

static UART_HandleTypeDef myUARTHandler;			// Handler del puerto UART

static void UART_Error_Handler(void);

// Funcion: inicializa el puerto UART con los parametros especificados
// Entrada: Ninguna
// Salida: True si se pudo abrir el puerto sin errores, false en caso contrario
bool_t uartinit(void)
{
	bool_t UART_Init_OK = true;

	// Configuracion del UART
	myUARTHandler.Instance			= USARTx;
	myUARTHandler.Init.BaudRate		= 9600;
	myUARTHandler.Init.WordLength	= UART_WORDLENGTH_8B;
	myUARTHandler.Init.StopBits		= UART_STOPBITS_1;
	myUARTHandler.Init.Parity		= UART_PARITY_ODD;
	myUARTHandler.Init.HwFlowCtl	= UART_HWCONTROL_NONE;
	myUARTHandler.Init.Mode			= UART_MODE_TX_RX;
	myUARTHandler.Init.OverSampling	= UART_OVERSAMPLING_16;

	if(HAL_UART_Init(&myUARTHandler) != HAL_OK)
	{
		// Error de inicializacion
		UART_Error_Handler();
		UART_Init_OK = false;
	}
	else
	{
		// Debug de configuracion del puerto
		uartSendString((uint8_t *)BAUDRATE);
		uartSendString((uint8_t *)WORD_LENGTH);
		uartSendString((uint8_t *)STOP_BITS);
		uartSendString((uint8_t *)PARITY);
		uartSendString((uint8_t *)HW_CTRL);
		uartSendString((uint8_t *)MODE);
		uartSendString((uint8_t *)OVERSAMPLING);
	}

	return UART_Init_OK;
}

void uartSendString(uint8_t * pstring)
{
	HAL_UART_Transmit(&myUARTHandler, pstring, strlen((const char *)pstring), 30);
}

void uartSendStringSize(uint8_t * pstring, uint16_t size)
{
	if((pstring != NULL) && (size > 0))
		HAL_UART_Transmit(&myUARTHandler, pstring, size, 30);
}

void uartReceiveStringSize(uint8_t * pstring, uint16_t size)
{
	if((pstring != NULL) && (size > 0))
		HAL_UART_Receive(&myUARTHandler, pstring, size, 30);
}

static void UART_Error_Handler(void)
{

}

